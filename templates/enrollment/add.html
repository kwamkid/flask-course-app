{% extends "base.html" %}
{% block title %}ลงทะเบียนนักเรียน{% endblock %}
{% block content %}

<style>

</style>

<form action="{{ url_for('enroll.enroll_form') }}" method="POST">
    <div class="container-fluid">
          <h1 class="h3 mb-4 text-primary">ลงทะเบียนนักเรียนใหม่</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">[STEP 1] เลือกนักเรียน</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="student-search">ค้นหานักเรียน:</label>
                            <input type="text" id="student-search" name="student_search" class="form-control mb-2" placeholder="ค้นหาชื่อนักเรียน..." required>
                            <input type="hidden" name="student_id" id="student-id" required>
                <div id="student-details" class="border p-2 bg-light position-relative" style="display: none;">
                            <button type="button" class="close position-absolute" style="top: 5px; right: 10px;" aria-label="Close" onclick="clearStudentSelection()">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong>ข้อมูลนักเรียนที่เลือก:</strong>
                            </div>
                                <p id="student-name" class="mb-0"></p>
                                <p id="student-email" class="mb-0 text-muted"></p>
                                <div id="student-enrollments" class="mt-3" style="display: none;">
                                    <strong>คลาสที่ลงทะเบียนแล้ว:</strong>
                                    <ul id="enrolled-classes" class="mb-0 list-unstyled small text-muted"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">[STEP 2] เลือกคลาสเรียน</h6>
                    </div>
                    <div class="card-body">
                        <div class="border rounded p-3">
                            <div class="form-row mb-3 d-flex align-items-center">
                              <div class="col-md-3">
                                <label for="course-filter" class="mb-0 mr-2">คอร์ส:</label>
                                {% set course_titles = [] %}
                                <select id="course-filter" class="form-control">
                                  <option value="">แสดงทั้งหมด</option>
                                  {% for cls in all_classes %}
                                  {% if cls.course['title'] not in course_titles %}
                                  <option value="{{ cls.course['title'] }}">{{ cls.course['title'] }}</option>
                                  {% set _ = course_titles.append(cls.course['title']) %}
                                  {% endif %}
                                  {% endfor %}
                                </select>
                              </div>
                              <div class="col-md-9">
                                <label for="class-search" class="mb-0 mr-2">ค้นหา:</label>
                                <input type="text" id="class-search" class="form-control" placeholder="ค้นหาคลาส...">
                              </div>
                            </div>

                            <div class="form-row mb-4">
                              <div class="col-md-12 d-flex align-items-center">
                                <label class="mb-0 mr-2">วันเรียน:</label>
                                <div id="day-filter" class="d-flex flex-wrap">
                                  {% set weekdays = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์', 'อาทิตย์'] %}
                                  {% for day in weekdays %}
                                  <div class="form-check form-check-inline mr-2">
                                    <input class="form-check-input day-checkbox" type="checkbox" value="{{ day }}" id="day-{{ loop.index }}">
                                    <label class="form-check-label" for="day-{{ loop.index }}">{{ day }}</label>
                                  </div>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>

                            <div class="form-group">
                                <div class="table-responsive">
                                    <table id="class-table" class="table table-bordered">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th>ชื่อคอร์ส</th>
                                            <th>ชื่อคลาส</th>
                                            <th>วัน-เวลา</th>
                                            <th>ช่วงวันที่</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for cls in all_classes %}
                                        <tr>
                                            <td>
                                                <input type="radio" name="class_id" value="{{ cls.id }}" required>
                                            </td>
                                            <td>
                                                <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background-color:{{ cls.course['color'] }};margin-right:6px;"></span>
                                                {{ cls.course['title'] }}
                                            </td>
                                            <td><strong>{{ cls.name }}</strong></td>
                                            <td>
  {{ cls.day_display }}<br>
  <small>{{ cls.start_time }} - {{ cls.end_time }}</small>
</td>
                                            <td>{{ cls.start_date }} - {{ cls.end_date }}</td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mb-3">
            {{ BUTTON_LABELS.ok_btn }}
        </button>
        <a href="{{ url_for('enroll.enrollment_list') }}" class="btn btn-secondary mb-3 ms-2">
            {{ BUTTON_LABELS.cancel_btn }}
        </a>
    </div>
</form>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const studentList = [
          {% for student in students %}
          {
            id: {{ student.id }},
            label: "{{ student.name }}",
            name: "{{ student.name }}",
            email: "{{ student.email or '' }}"
          },
          {% endfor %}
      ];

      if (window.jQuery) {
        $("#student-search").autocomplete({
            source: studentList,
            minLength: 1,
            select: function(event, ui) {
                $("#student-id").val(ui.item.id);
                $("#student-name").text("ชื่อ: " + ui.item.name);
                $("#student-email").text("อีเมล: " + (ui.item.email || "ไม่มีข้อมูล"));
                $("#student-details").show();

                fetch(`/api/student_enrollments/${ui.item.id}`)
                    .then(res => res.json())
                    .then(data => {
                        const list = document.getElementById('enrolled-classes');
                        list.innerHTML = '';
                        if (data.length > 0) {
                        data.forEach(item => {
                            const li = document.createElement('li');
                            const formattedDays = item.days.map(d => 'วัน' + d).join(' ');
                            li.innerHTML = `<strong>${item.class_name}</strong><br>รอบวัน: ${formattedDays} เวลา: ${item.start_time} - ${item.end_time}`;
                            list.appendChild(li);
                        });
                            document.getElementById('student-enrollments').style.display = 'block';
                        } else {
                            document.getElementById('student-enrollments').style.display = 'none';
                        }
                    });

                $('a[href="#class"]').tab("show");
            }
        });

        $("#student-search").on('input', function () {
            if ($(this).val().trim() === "") {
                $("#student-id").val('');
                $("#student-details").hide();
            }
        });
      } else {
        console.error("❌ jQuery not loaded before autocomplete init");
      }
    });
</script>

<script>
  function clearStudentSelection() {
      $("#student-id").val('');
      $("#student-search").val('');
      $("#student-details").hide();
      $("#student-enrollments").hide();
      $("#enrolled-classes").html('');
      // Optional: show all class rows again
      $("#class-table tbody tr").show();
  }

  function refreshAvailableClasses(studentId) {
    fetch(`/get_available_classes/${studentId}`)
      .then(response => response.json())
      .then(data => {
        const allowedClassIds = data.map(cls => cls.id);
        console.log("✅ Allowed class IDs:", allowedClassIds); // ✅ Debug line
        $("#class-table tbody tr").each(function () {
          const row = $(this);
          const classId = parseInt(row.find('input[name="class_id"]').val());
          console.log("🔍 Checking class row with ID:", classId); // ✅ Debug line
          if (allowedClassIds.includes(classId)) {
            row.show();
          } else {
            row.hide();
          }
        });
      });
  }

  $(document).ready(function () {
    const studentInput = $("#student-search");
    if (studentInput.length) {
      studentInput.on("autocompleteselect", function (event, ui) {
        $("#student-id").val(ui.item.id);
        $("#student-name").text("ชื่อ: " + ui.item.name);
        $("#student-email").text("อีเมล: " + (ui.item.email || "ไม่มีข้อมูล"));
        $("#student-details").show();
        refreshAvailableClasses(ui.item.id);
        $('a[href="#class"]').tab("show");
      });
    }
  });
</script>

<script>
    function initDataTableAndFilters() {
      const table = $('#class-table').DataTable({
          searching: false,
          lengthChange: false,
          language: {
              zeroRecords: "ไม่พบข้อมูล",
              info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
              infoEmpty: "ไม่มีข้อมูล",
              infoFiltered: "(ค้นหาจากทั้งหมด _MAX_ รายการ)"
          }
      });

      $('#course-filter').on('change', function () {
          const val = $(this).val().toLowerCase();
          table.rows().every(function () {
              const courseCell = $(this.node()).find('td:eq(1)').text().toLowerCase();
              $(this.node()).toggle(!val || courseCell.includes(val));
          });
      });

      $('#class-search').on('keyup', function () {
          const query = this.value.toLowerCase();
          table.rows().every(function () {
              const rowText = $(this.node()).text().toLowerCase();
              $(this.node()).toggle(rowText.includes(query));
          });
      });

      $('#day-filter input[type="checkbox"]').on('change', function () {
          const selectedDays = $('#day-filter input[type="checkbox"]:checked')
              .map(function () { return $(this).val(); }).get();

          table.rows().every(function () {
              const dayCell = this.data()[4];
              const match = selectedDays.every(day => dayCell.includes(day));
              $(this.node()).toggle(match);
          });
      });
    }

    function waitForjQueryThenInit() {
      if (typeof $ !== 'undefined' && typeof $.fn !== 'undefined' && $.fn.DataTable) {
        $(function () {
          initDataTableAndFilters();
        });
      } else {
        console.warn("⏳ Waiting for jQuery & DataTables to load...");
        setTimeout(waitForjQueryThenInit, 100);
      }
    }

    window.addEventListener('DOMContentLoaded', waitForjQueryThenInit);
</script>

{% endblock %}