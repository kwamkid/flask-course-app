{% extends "base.html" %}
{% block title %}‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™{% endblock %}
{% block content %}

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 text-primary">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
        <a href="{{ url_for('enroll.enroll_form') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </a>
    </div>

    <div class="mb-4 d-flex flex-wrap align-items-end">
        <div class="form-group mr-3">
            <label for="class-search">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏≤‡∏™:</label>
            <input type="text" id="class-search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™...">
        </div>
        <div class="form-group mr-3">
            <label for="student-search">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
            <input type="text" id="student-search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
        </div>
        <div class="form-group mr-3">
            <label for="course-filter">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
            <select id="course-filter" class="form-control">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                {% for course in course_list %}
                <option value="{{ course.title }}">{{ course.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-3">
            <label for="status-filter">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏™:</label>
            <select id="status-filter" class="form-control">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="ongoing">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</option>
                <option value="completed">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
        </div>
        <div class="form-group mr-3">
            <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
            <div id="day-filter" class="d-flex flex-wrap">
                {% set weekdays = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'] %}
                {% for day in weekdays %}
                <div class="form-check form-check-inline mr-2">
                    <input class="form-check-input day-checkbox" type="checkbox" value="{{ day }}" id="day-{{ loop.index }}">
                    <label class="form-check-label" for="day-{{ loop.index }}">{{ day }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>


    <!-- New card layout: flex-based responsive grid -->
    <div id="class-container" class="row g-3 justify-content-start">
        {% for cls in class_list %}
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card shadow mb-4 class-card" data-name="{{ cls.name | lower }}" data-days="{% set ds = cls.days.split(',') %}{{ ds | join(' ') }}">
                <div class="card-header text-white" style="background-color: {{ cls.course.color or '#dc3545' }};">
                    <div><strong>{{ cls.name }}</strong></div>
                    <div>üßë‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {{ cls.enrollments|length }} ‡∏Ñ‡∏ô</div>
                </div>
                <div class="card-body">
                    {% if cls.enrollments %}
                    <ul class="list-unstyled mb-0">
                        {% for enroll in cls.enrollments %}
                        <li class="mb-3">
                            <strong>{{ loop.index }}.</strong>
                            <a href="{{ url_for('student.student_view', student_id=enroll.student.id) }}" class="text-dark font-weight-bold">
                                {{ enroll.student.name }} ({{ enroll.student.nickname or '-' }})
                            </a><br>
                            <span>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {{ enroll.student.school_name or '-' }} - {{ enroll.student.school_level or '-' }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function applyClassFilters() {
      const searchVal = document.getElementById('class-search').value.toLowerCase();
      const studentVal = document.getElementById('student-search').value.toLowerCase();
      const courseVal = document.getElementById('course-filter').value.toLowerCase();
      const statusVal = document.getElementById('status-filter').value;
      const checkedDays = Array.from(document.querySelectorAll('#day-filter input:checked')).map(cb => cb.value);

    document.querySelectorAll('.class-card').forEach(card => {
  const col = card.closest('.col-lg-4, .col-md-6, .col-sm-12');


        const name = card.dataset.name;
        const days = card.dataset.days;
        const studentNames = Array.from(card.querySelectorAll('li')).map(li => li.textContent.toLowerCase()).join(' ');
        const courseTitle = card.querySelector('.card-header div strong')?.textContent?.toLowerCase() || '';
        const studentCount = parseInt(card.querySelector('.card-header div:nth-child(2)')?.textContent?.match(/\d+/)?.[0]) || 0;

        const matchSearch = !searchVal || name.includes(searchVal);
        const matchStudent = !studentVal || studentNames.includes(studentVal);
        const matchCourse = !courseVal || courseTitle.includes(courseVal);
        const matchDays = checkedDays.every(day => days.includes(day));

        let matchStatus = true;
        if (statusVal === 'ongoing') {
          matchStatus = studentCount > 0;
        } else if (statusVal === 'completed') {
          matchStatus = studentCount === 0;
        }

         if (matchSearch && matchStudent && matchCourse && matchDays && matchStatus) {
    col.style.display = '';
  } else {
    col.style.display = 'none';
  }
});
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('class-search').addEventListener('input', applyClassFilters);
      document.getElementById('student-search').addEventListener('input', applyClassFilters);
      document.getElementById('course-filter').addEventListener('change', applyClassFilters);
      document.getElementById('status-filter').addEventListener('change', applyClassFilters);
      document.querySelectorAll('#day-filter input').forEach(cb => {
        cb.addEventListener('change', applyClassFilters);
      });
    });
</script>

{% endblock %}